# API

## Авторизация

	curl -u login:password http://localhost:8080/api/v1/login

В ответ приходит токен в формате JWT:

	eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE0NDkxMjEyNjMsImdyb3VwIjoiNTQwZGE1NDQtOTgxYy0xMWU1LWEyMmUtMjhjZmU5MWE4NmE3IiwiaWQiOiI1NjVmYTgzZTM0NWVkOTliOTdjNGVhNTYiLCJpc3MiOiJjb20ueHl6cmQudHJhY2tlciJ9.Qpb8vt_BAYalpHJnMKmkjHN3pvxZNEtikhO6qkWXV5I

Пока токен действителен в течение *30* минут, после чего его нужно получать заново. Это сделано специально для отладки: в дальнейшем время жизни токена может увеличится до 72 часов.

При каждой перезагрузке сервера случайным образом меняется ключ, которым подписывается данный токен. Поэтому придется получать этот токен заново: старый будет уже не действителен.

В расшифрованном виде токен содержит время жизни, идентификатор сервиса и минимальную информацию об идентификаторах пользователя:

	{
	  "exp": 1449117063,
	  "iss": "com.xyzrd.geotracker",
	  "id": "565fa83e345ed99b97c4ea56",
	  "group": "540da544-981c-11e5-a22e-28cfe91a86a7",
	}

Все обращения к API должны в обязательном порядке использовать полученный токен при запросе. Токен лучше всего передавать в заголовке авторизации HTTP, используя в качестве метода авторизации имя `Bearer`:

	curl -H "Authorization: Bearer <token>" http://localhost:8080/api/v1/users

В качетсве альтернативы токен можно так же указывать и в URL самого запроса, используя для этого параметр с именем `token`:

	curl http://localhost:8080/api/v1/users?token=<token>

Последний вариант запроса рекомендуется использовать исключительно для отладки, т.к. он обеспечивает существенно меньшую безопасность. В дальнейшем этот вариант передачи токена может быть заблокирован.


## Получение списка пользователей

	curl -H "Authorization: Bearer <token>" http://localhost:8080/api/v1/users

Возвращает список всех зарегистрированных пользователей в данной группе, включая и себя:

	[
		{
			"ID": "565fa83e345ed99b97c4ea56",
			"Login": "login1",
			"Name": "User #1",
			"Icon": 0
		},
		{
			"ID": "565fa83e345ed99b97c4ea57",
			"Login": "login2",
			"Icon": 1
		},
		{
			"ID": "565fa83e345ed99b97c4ea58",
			"Login": "login3",
			"Name": "User #3",
			"Icon": 2
		},
		{
			"ID": "565fa83e345ed99b97c4ea59",
			"Login": "login4",
			"Icon": 3
		},
		{
			"ID": "565fa83e345ed99b97c4ea5a",
			"Login": "login5",
			"Name": "User #5",
			"Icon": 4
		}
	]

## Получение списка мест

	curl -H "Authorization: Bearer <token>" http://localhost:8080/api/v1/places

Возвращает список всех мест, зарегистрированных для данной группы:

	[
		{
			"ID": "565f3d41345ed988d93cacd3",
			"Name": "Работа",
			"Polygon": [
				[[37.5667, 55.7152], [37.5688, 55.7167], [37.5703, 55.7169], [37.5706, 55.7168],
				 [37.5726, 55.7159], [37.5728, 55.7158], [37.5731, 55.7159], [37.5751, 55.7152],
				 [37.5758, 55.7148], [37.5755, 55.7144], [37.5749, 55.7141], [37.5717, 55.7131],
				 [37.5709, 55.7128], [37.5694, 55.7125], [37.5661, 55.7145], [37.566, 55.7147],
				 [37.5667, 55.7152]]
			]
		},
		{
			"ID": "565f3d41345ed988d93cacd4",
			"Name": "Дом",
			"Circle": {
				"Center": [37.589248, 55.765944],
				"Radius": 200
			}
		},
		{
			"ID": "565f3d41345ed988d93cacd5",
			"Name": "Знаменский монастырь",
			"Polygon": [
				[[37.6256, 55.7522], [37.6304, 55.7523], [37.631, 55.7527], [37.6322, 55.7526],
				 [37.632, 55.7521], [37.6326, 55.7517], [37.6321, 55.7499], [37.6305, 55.7499],
				 [37.6305, 55.7502], [37.6264, 55.7504], [37.6264, 55.75], [37.6254, 55.75],
				 [37.6253, 55.752], [37.6256, 55.7522]]
			]
		}
	]

Места могут быть определены как полигон или круг (см. пример выше).


## Получение списка устройств

	curl -H "Authorization: Bearer <token>" http://localhost:8080/api/v1/devices

Возвращает список всех идентификаторов устройств, зарегистрированных для данной группы:

	[
		"test0123456789",
		"test9876543210"
	]

Сейчас возвращаются только те идентификаторы устройств, по которым есть данные трекинга. В дальнейшем этот механизм будет изменен и будут возвращаться идентификаторы всех зарегистрированных устройств.


## Получение последних данных устройства

	curl -H "Authorization: Bearer <token>" http://localhost:8080/api/v1/devices/test0123456789

Возвращает последние координаты, полученные с данного устройства:

	{
		"ID": "565fa11de401cc50ba1284d1",
		"Time": "2015-12-03T00:59:09.645+03:00",
		"Point": [37.68454428212746, 55.72747138508032],
		"Type": 1
	}

`Type` — указывает тип полученных координат:

- `0` — неизвестный метод
- `1` — координаты получены через GPS
- `2` — координаты получены по точкам Wi-Fi
- `4` — координаты получены методом вычисления по LBS

Если `Type` не указан, то считается, что его значение `0`.


## Получение истории данных устройства

	curl -H "Authorization: Bearer <token>" http://localhost:8080/api/v1/devices/test0123456789/history

Для навигации по страницам истории можно указывать в параметры последний полученный идентификатор: в этом случае вывод начнется с более старых данных, чем в указанном идентификаторе.

	curl -H "Authorization: Bearer <token>" http://localhost:8080/api/v1/devices/test0123456789/history?lastid=565fa11de401cc50ba1284c8

Возвращает последние координаты, полученные с данного устройства:

	[
		{
			"ID": "565fa11de401cc50ba1284d1",
			"Time": "2015-12-03T00:59:09.645+03:00",
			"Point": [37.68454428212746, 55.72747138508032]
		},
		{
			"ID": "565fa11de401cc50ba1284d0",
			"Time": "2015-12-03T00:57:59.8+03:00",
			"Point": [37.68419267639476, 55.72766069897311],
			"Type": 0
		},
		{
			"ID": "565fa11de401cc50ba1284cf",
			"Time": "2015-12-03T00:54:24.267+03:00",
			"Point": [37.683480852345724, 55.7280431528877],
			"Type": 1
		},
		{
			"ID": "565fa11de401cc50ba1284ce",
			"Time": "2015-12-03T00:49:04.791+03:00",
			"Point": [37.683240454770555, 55.72845123359339],
			"Type": 2
		},
		{
			"ID": "565fa11de401cc50ba1284cd",
			"Time": "2015-12-03T00:47:44.079+03:00",
			"Point": [37.68271525491059, 55.7289066991657],
			"Type": 4
		},
		{
			"ID": "565fa11de401cc50ba1284cc",
			"Time": "2015-12-03T00:47:29.194+03:00",
			"Point": [37.68269144668715, 55.72893997789171],
			"Type": 1
		},
		{
			"ID": "565fa11de401cc50ba1284cb",
			"Time": "2015-12-03T00:39:05.164+03:00",
			"Point": [37.6761710121059, 55.73150275481308],
			"Type": 1
		},
		{
			"ID": "565fa11de401cc50ba1284ca",
			"Time": "2015-12-03T00:31:43.311+03:00",
			"Point": [37.675631793699175, 55.73189641459608],
			"Type": 1
		},
		{
			"ID": "565fa11de401cc50ba1284c9",
			"Time": "2015-12-03T00:25:51.223+03:00",
			"Point": [37.675608110163964, 55.731923698241275],
			"Type": 1
		},
		{
			"ID": "565fa11de401cc50ba1284c8",
			"Time": "2015-12-03T00:19:11.367+03:00",
			"Point": [37.674651057691236, 55.732965217181935],
			"Type": 1
		}
	]

`Type` — указывает тип полученных координат:

- `0` — неизвестный метод
- `1` — координаты получены через GPS
- `2` — координаты получены по точкам Wi-Fi
- `4` — координаты получены методом вычисления по LBS

Если `Type` не указан, то считается, что его значение `0`.



## Регистрация токена устройства

	curl -H "Authorization: Bearer <token>" -d "deviceid=<deviceID>&token=<token_string>" http://localhost:8080/api/v1/register/apns

Регистрирует указанный токен устройства в хранилище, чтобы можно было отправлять на это устройства сообщения. Используется метод HTTP POST. В качестве параметров передаются уникальный идентификатор устройства и сам токен устройства, полученный от сервиса Apple для получения push-уведомлений. Так же в URL запроса указывается тип: Apple Push Notification — `apns`, Google Cloud Messaging — `gcm`.

Для удаление токена устройства используется аналогичный запрос с методом HTTP DELETE:

	curl -H "Authorization: Bearer <token>" -X DELETE http://localhost:8080/api/v1/register/apns/<token>
